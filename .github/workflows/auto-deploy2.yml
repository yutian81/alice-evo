name: ğŸš€ Alice Evo VM è‡ªåŠ¨éƒ¨ç½² Plus

on:
  schedule:
    - cron: '0 19 * * *'
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'é€‰æ‹©è¿è¡Œæ¨¡å¼'
        required: true
        default: 'both'
        type: choice
        options:
          - both # é”€æ¯ + éƒ¨ç½² + é…ç½®
          - deploy_only # ä»…é”€æ¯ + éƒ¨ç½²
          - setup_only # ä»…é…ç½® (å®Œå…¨ä¾èµ–é»˜è®¤å€¼å’Œç¯å¢ƒ)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ å®‰è£…ä¾èµ– (jq, sshpass)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq ssh sshpass

      - name: ğŸ”‘ æ³¨å…¥ SSH ç§é’¥åˆ° Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ALICE_SSH_KEY }}

      - name: ğŸš€ è¿è¡Œéƒ¨ç½²è„šæœ¬ (Renew)
        id: deploy_run
        if: github.event_name == 'schedule' || github.event.inputs.run_mode != 'setup_only'
        env:
          ALICE_CLIENT_ID: ${{ secrets.ALICE_CLIENT_ID }}
          ALICE_API_SECRET: ${{ secrets.ALICE_API_SECRET }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          chmod +x alice-renew2.sh
          # å¦‚æœæˆåŠŸï¼Œä¼šè¾“å‡ºï¼šID IP USER PASS HOST
          RESULT=$(./alice-renew2.sh)
          echo "NEW_INSTANCE_DATA=$RESULT" >> $GITHUB_OUTPUT

      - name: âš™ï¸ è¿è¡Œé…ç½®è„šæœ¬ (Setup)
        if: always() && (github.event_name == 'schedule' || github.event.inputs.run_mode != 'deploy_only')
        env:
          NODEJS_COMMAND: ${{ vars.NODEJS_COMMAND }}
        run: |
          chmod +x alice-setup.sh
          PARAMS="${{ steps.deploy_run.outputs.NEW_INSTANCE_DATA }}"

          echo "å¯åŠ¨è¿œç¨‹è„šæœ¬ï¼Œå‚æ•°: $PARAMS"
          ./alice-setup.sh $PARAMS
